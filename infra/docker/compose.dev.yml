
version: "3.9"
name: m0club-dev

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: m0
      POSTGRES_PASSWORD: m0
      POSTGRES_DB: m0club
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U m0 -d m0club"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build:
      context: ../../services/api-gateway
      dockerfile: Dockerfile
    environment:
      RUST_LOG: info
      M0_LOG_JSON: "0"
      M0_API_KEYS: ""
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["m0-api-gateway", "--bind", "0.0.0.0:8080", "--enable-openapi", "true"]

  realtime:
    build:
      context: ../../services/realtime
      dockerfile: Dockerfile
    environment:
      RUST_LOG: info
    ports:
      - "8090:8090"
    command: ["m0-realtime", "--bind", "0.0.0.0:8090"]

  indexer:
    build:
      context: ../../services/indexer
      dockerfile: Dockerfile
    environment:
      RUST_LOG: info
    depends_on:
      postgres:
        condition: service_healthy
    command: ["m0-indexer", "--rpc-url", "https://api.devnet.solana.com"]

  jobs:
    build:
      context: ../../services/jobs
      dockerfile: Dockerfile
    environment:
      RUST_LOG: info
    command: ["m0-jobs", "--interval-secs", "30"]

  dashboard:
    build:
      context: ../../services/dashboard
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: "http://localhost:8080"
      NEXT_PUBLIC_WS_URL: "ws://localhost:8090/ws"
    ports:
      - "3000:3000"
    depends_on:
      - api
      - realtime

volumes:
  pgdata:
